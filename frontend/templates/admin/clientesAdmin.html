<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clientes - Panel de Administraci√≥n</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Work+Sans:wght@400;500;700;900&display=swap" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="stylesheet" href="../../static/css/admin/sidebarAdmin.css">
  <style>
    :root {
      --c1: #aa8744;
      --c2: #363636;
      --c3: #fdfbf3;
      --c4: #d1bc97;
      --c5: #9c642d;
      --radius: 10px;
      --shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 12px;
      color: white;
    }

    .badge.activo {
      background: #16a34a;
    }

    .badge.inactivo {
      background: #dc2626;
    }

    .badge.historico {
      background: #6b7280;
    }

    .page-btn {
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--c2);
      background: none;
      border: 1px solid var(--c4);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-btn.active {
      background-color: var(--c1);
      color: white;
      border-color: var(--c1);
    }

    .page-btn:hover:not(.active) {
      background-color: #f3f3f3;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .cliente-eliminado {
      opacity: 0.7;
      background-color: #f9fafb !important;
    }

    .cliente-eliminado td {
      color: #6b7280 !important;
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body class="bg-[#fdfbf3] font-['Work_Sans','Noto_Sans',sans-serif]">
  <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
    <div class="flex h-full w-full flex-1">

      <!-- Sidebar unificado -->
      <aside class="admin-sidebar">
        <div class="sidebar-container">
          <div class="sidebar-header">
            <h1 class="sidebar-title">Meraki</h1>
            <nav class="sidebar-nav">
              <a class="nav-item" href="/dashboard">
                <span class="material-symbols-outlined">home</span>
                <p>Inicio</p>
              </a>
              <a class="nav-item" href="/pedidos">
                <span class="material-symbols-outlined">package_2</span>
                <p>Pedidos</p>
              </a>
              <a class="nav-item" href="/productos">
                <span class="material-symbols-outlined">list_alt</span>
                <p>Productos</p>
              </a>
              <a class="nav-item" href="/categorias">
                <span class="material-symbols-outlined">category</span>
                <p>Categor√≠as</p>
              </a>
              <a class="nav-item active" href="/clientes">
                <span class="material-symbols-outlined">group</span>
                <p>Clientes</p>
              </a>
              <a class="nav-item" href="#">
                <span class="material-symbols-outlined">bar_chart</span>
                <p>Reportes</p>
              </a>
            </nav>
          </div>
          <div class="sidebar-footer">
            <a class="nav-item" href="/auth/logout">
              <span class="material-symbols-outlined">logout</span>
              <p>Cerrar sesi√≥n</p>
            </a>
          </div>
        </div>
      </aside>

      <!-- Contenido principal -->
      <main class="main-content">
        <div class="p-6 md:p-8">
          <!-- Header -->
          <header class="mb-8">
            <div class="flex items-center justify-between">
              <h1 class="text-4xl font-bold text-[#363636]">Gesti√≥n de Clientes</h1>
            </div>
          </header>

          <!-- Panel de b√∫squeda y filtros -->
          <div class="mb-6 bg-white p-6 rounded-xl shadow-sm border border-[#d1bc97]">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="md:col-span-2">
                <div class="relative">
                  <span
                    class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-[#9c642d]">
                    search
                  </span>
                  <input id="searchInput" type="text" placeholder="Buscar clientes por nombre, correo o tel√©fono..."
                    class="w-full pl-10 pr-4 py-3 border border-[#d1bc97] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#aa8744] focus:border-transparent">
                </div>
              </div>
              <div>
                <select id="filtroEstado"
                  class="w-full py-3 px-4 border border-[#d1bc97] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#aa8744] focus:border-transparent">
                  <option value="activos">Activos</option>
                  <option value="eliminados">Eliminados</option>
                  <option value="todos">Todos</option>
                </select>
              </div>
              <div>
                <button id="btnBuscar"
                  class="w-full bg-[#aa8744] hover:bg-[#9c642d] text-white py-3 px-4 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors">
                  <span class="material-symbols-outlined">search</span>
                  <span>Buscar</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Tabla de clientes -->
          <div class="bg-white rounded-xl shadow-sm border border-[#d1bc97] overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-[#fdfbf3] border-b border-[#d1bc97]">
                  <tr>
                    <th class="py-4 px-6 text-left font-semibold text-[#9c642d] uppercase tracking-wider text-sm">Nombre
                    </th>
                    <th class="py-4 px-6 text-left font-semibold text-[#9c642d] uppercase tracking-wider text-sm">
                      Contacto</th>
                    <th class="py-4 px-6 text-center font-semibold text-[#9c642d] uppercase tracking-wider text-sm">
                      Puntos de Fidelidad</th>
                    <th class="py-4 px-6 text-center font-semibold text-[#9c642d] uppercase tracking-wider text-sm">
                      Estado</th>
                  </tr>
                </thead>
                <tbody id="clientesBody" class="divide-y divide-[#d1bc97]">
                  <tr id="loadingRow">
                    <td colspan="4" class="py-8 px-6 text-center text-[#9c642d]">
                      <div class="flex items-center justify-center">
                        <span class="material-symbols-outlined animate-spin mr-2">refresh</span>
                        Cargando clientes...
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Paginaci√≥n -->
          <div class="flex justify-between items-center mt-6">
            <span id="infoPaginacion" class="text-sm text-gray-500">Mostrando 0 de 0 clientes</span>
            <div id="paginacion" class="flex items-center gap-2">
              <!-- Los botones de paginaci√≥n se generar√°n din√°micamente -->
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // clientesAdmin.js - VERSI√ìN MEJORADA Y CORREGIDA

    document.addEventListener("DOMContentLoaded", () => {
      console.log("‚úÖ Script clientesAdmin.js cargado");

      // Elementos del DOM
      const tbody = document.getElementById("clientesBody");
      const searchInput = document.getElementById("searchInput");
      const filtroEstado = document.getElementById("filtroEstado");
      const btnBuscar = document.getElementById("btnBuscar");
      const paginacionEl = document.getElementById("paginacion");
      const infoPaginacionEl = document.getElementById("infoPaginacion");

      // Variables de estado
      let clientes = [];
      let filtroActual = "activos";
      let busquedaActual = "";
      let paginaActual = 1;
      const clientesPorPagina = 10;

      // Configuraci√≥n de API
      const API_BASE = 'http://127.0.0.1:8000';
      const CLIENTES_ENDPOINT = `${API_BASE}/clientes/`;

      console.log("üîó Endpoint de API:", CLIENTES_ENDPOINT);

      // Verificar que todos los elementos del DOM existen
      if (!tbody || !paginacionEl || !infoPaginacionEl) {
        console.error("‚ùå Elementos del DOM no encontrados");
        showError("Error: No se pudieron cargar los elementos de la p√°gina");
        return;
      }

      console.log("‚úÖ Todos los elementos del DOM encontrados");

      /* ---------- Cargar clientes ---------- */
      async function cargarClientes() {
        console.log("üîÑ Cargando clientes...");
        console.log("üìä Par√°metros:", { filtroActual, paginaActual, busquedaActual });

        try {
          showLoading();

          const params = new URLSearchParams({
            estado: filtroActual,
            pagina: paginaActual.toString(),
            itemsPorPagina: clientesPorPagina.toString()
          });

          if (busquedaActual) {
            params.append('busqueda', busquedaActual);
          }

          const url = `${CLIENTES_ENDPOINT}?${params}`;
          console.log("üì° URL completa:", url);

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            credentials: 'include'
          });

          console.log("üì° Estado de respuesta:", response.status, response.statusText);

          if (!response.ok) {
            let errorMessage = `Error ${response.status}: ${response.statusText}`;

            // Intentar obtener m√°s detalles del error
            try {
              const errorData = await response.json();
              errorMessage = errorData.detail || errorMessage;
            } catch (e) {
              // Si no se puede parsear como JSON, usar el texto plano
              const errorText = await response.text();
              if (errorText) {
                errorMessage += ` - ${errorText}`;
              }
            }

            if (response.status === 401) {
              errorMessage = "No autorizado - Verifica que est√©s logueado como administrador";
            } else if (response.status === 403) {
              errorMessage = "Acceso denegado - No tienes permisos de administrador";
            }

            throw new Error(errorMessage);
          }

          const data = await response.json();
          console.log("üì¶ Datos recibidos:", data);
          console.log("üë• Clientes en respuesta:", data.clientes ? data.clientes.length : 0);

          // Procesar respuesta
          clientes = Array.isArray(data.clientes) ? data.clientes : [];

          if (data.paginacion) {
            renderizarClientes(data.paginacion);
          } else {
            console.warn("‚ö†Ô∏è No hay datos de paginaci√≥n en la respuesta");
            renderizarClientes({
              totalItems: clientes.length,
              paginaActual: paginaActual,
              itemsPorPagina: clientesPorPagina,
              totalPaginas: Math.ceil(clientes.length / clientesPorPagina)
            });
          }

        } catch (error) {
          console.error("‚ùå Error cargando clientes:", error);
          showError(`Error: ${error.message}`);
        }
      }

      /* ---------- Renderizar clientes ---------- */
      function renderizarClientes(paginacion) {
        console.log("üé® Renderizando", clientes.length, "clientes");

        tbody.innerHTML = '';

        // Mostrar mensaje si no hay clientes
        if (clientes.length === 0) {
          const mensaje = filtroActual === "eliminados"
            ? "No hay clientes eliminados"
            : filtroActual === "todos"
              ? "No hay clientes registrados"
              : "No se encontraron clientes activos";

          tbody.innerHTML = `
            <tr>
              <td colspan="4" class="py-12 px-6 text-center">
                <div class="flex flex-col items-center justify-center text-[#9c642d]">
                  <span class="material-symbols-outlined text-5xl mb-3">group</span>
                  <p class="text-xl font-semibold mb-2">${mensaje}</p>
                  <p class="text-sm text-gray-600">${busquedaActual ? 'Intenta con otros t√©rminos de b√∫squeda' : 'Los clientes aparecer√°n aqu√≠ una vez registrados'}</p>
                </div>
              </td>
            </tr>`;

          const total = paginacion.total_items || 0;
          actualizarInfoPaginacion(0, total);
          renderizarPaginacion(paginacion.total_paginas || 1);
          return;
        }

        // Crear filas para cada cliente
        clientes.forEach((cliente) => {
          const tr = document.createElement("tr");

          // Determinar clase seg√∫n el tipo de cliente
          if (filtroActual === "eliminados" || cliente.tipo === "historico") {
            tr.className = "cliente-eliminado hover:bg-gray-100";
          } else {
            tr.className = "hover:bg-[#fdfbf3]";
          }

          // Determinar estado y puntos
          let estado, puntos, estadoClass;

          if (filtroActual === "eliminados" || cliente.tipo === "historico") {
            estado = "Eliminado";
            estadoClass = "badge historico";
            puntos = "N/A";
          } else if (cliente.activo === false) {
            estado = "Inactivo";
            estadoClass = "badge inactivo";
            puntos = cliente.puntos || 0;
          } else {
            estado = "Activo";
            estadoClass = "badge activo";
            puntos = cliente.puntos || 0;
          }

          // Formatear fecha si existe
          let fechaInfo = '';
          if (cliente.fechaEliminacion) {
            fechaInfo = `<br><span class="text-xs text-gray-500">Eliminado: ${formatFecha(cliente.fechaEliminacion)}</span>`;
          } else if (cliente.fechaCreacion && filtroActual === "todos") {
            fechaInfo = `<br><span class="text-xs text-gray-500">Registro: ${formatFecha(cliente.fechaCreacion)}</span>`;
          }

          tr.innerHTML = `
            <td class="py-4 px-6">
              <p class="font-semibold text-[#363636] text-base">${escapeHtml(cliente.nombre)}</p>
            </td>
            <td class="py-4 px-6">
              <p class="text-[#9c642d] text-sm font-medium">${escapeHtml(cliente.email)}</p>
              <p class="text-gray-600 text-sm">${escapeHtml(cliente.telefono || 'No proporcionado')}</p>
            </td>
            <td class="py-4 px-6 text-center">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-[#aa8744] text-white">
                ${puntos} ${typeof puntos === 'number' ? 'pts' : ''}
              </span>
            </td>
            <td class="py-4 px-6 text-center">
              <span class="${estadoClass}">
                ${estado}
              </span>
              ${fechaInfo}
            </td>`;

          tbody.appendChild(tr);
        });

        // Actualizar informaci√≥n de paginaci√≥n
        const total = paginacion.total_items || clientes.length;
        const mostrando = Math.min(clientes.length, clientesPorPagina);
        actualizarInfoPaginacion(mostrando, total);
        renderizarPaginacion(paginacion.total_paginas || 1);
      }

      /* ---------- Funciones de paginaci√≥n ---------- */
      function actualizarInfoPaginacion(mostrando, total) {
        if (infoPaginacionEl) {
          infoPaginacionEl.textContent = `Mostrando ${mostrando} de ${total} clientes`;
        }
      }

      function renderizarPaginacion(totalPaginas) {
        paginacionEl.innerHTML = '';

        if (totalPaginas <= 1) return;

        // Bot√≥n Anterior
        const btnAnterior = document.createElement("button");
        btnAnterior.textContent = "Anterior";
        btnAnterior.className = "page-btn";
        btnAnterior.disabled = paginaActual === 1;
        btnAnterior.addEventListener("click", () => {
          if (paginaActual > 1) {
            paginaActual--;
            cargarClientes();
          }
        });
        paginacionEl.appendChild(btnAnterior);

        // Botones de n√∫meros de p√°gina
        const inicio = Math.max(1, paginaActual - 2);
        const fin = Math.min(totalPaginas, inicio + 4);

        for (let i = inicio; i <= fin; i++) {
          const btnPagina = document.createElement("button");
          btnPagina.textContent = i;
          btnPagina.className = "page-btn" + (i === paginaActual ? " active" : "");
          btnPagina.addEventListener("click", () => {
            paginaActual = i;
            cargarClientes();
          });
          paginacionEl.appendChild(btnPagina);
        }

        // Bot√≥n Siguiente
        const btnSiguiente = document.createElement("button");
        btnSiguiente.textContent = "Siguiente";
        btnSiguiente.className = "page-btn";
        btnSiguiente.disabled = paginaActual === totalPaginas;
        btnSiguiente.addEventListener("click", () => {
          if (paginaActual < totalPaginas) {
            paginaActual++;
            cargarClientes();
          }
        });
        paginacionEl.appendChild(btnSiguiente);
      }

      /* ---------- UI Functions ---------- */

      // Mostrar estado de carga
      function showLoading() {
        tbody.innerHTML = `
          <tr id="loadingRow">
            <td colspan="4" class="py-12 px-6 text-center text-[#9c642d]">
              <div class="flex flex-col items-center justify-center">
                <span class="material-symbols-outlined animate-spin text-4xl mb-2">refresh</span>
                <p class="text-lg">Cargando clientes...</p>
              </div>
            </td>
          </tr>`;
      }

      // Mostrar mensaje de error
      function showError(message) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="py-12 px-6 text-center">
              <div class="flex flex-col items-center justify-center text-red-600">
                <span class="material-symbols-outlined text-4xl mb-2">error</span>
                <p class="text-lg font-medium mb-2">Error de conexi√≥n</p>
                <p class="text-sm text-gray-600 max-w-md">${message}</p>
                <div class="flex gap-2 mt-4">
                  <button onclick="location.reload()" class="px-4 py-2 bg-[#aa8744] text-white rounded-lg hover:bg-[#9c642d] transition-colors">
                    Reintentar
                  </button>
                  <button onclick="probarEndpoint()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Probar Conexi√≥n
                  </button>
                </div>
              </div>
            </td>
          </tr>`;
      }

      // Funci√≥n para probar el endpoint manualmente
      window.probarEndpoint = async function () {
        try {
          console.log("üîç Probando conexi√≥n con el endpoint...");
          const testUrl = `${CLIENTES_ENDPOINT}?estado=activos&pagina=1&items_por_pagina=5`;
          console.log("üîç URL de prueba:", testUrl);

          const response = await fetch(testUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            credentials: 'include'
          });

          console.log("üîç Resultado prueba:", {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
          });

          if (response.ok) {
            const data = await response.json();
            console.log("üîç Datos de prueba:", data);
            alert(`‚úÖ Conexi√≥n exitosa\nEstado: ${response.status}\nClientes encontrados: ${data.clientes ? data.clientes.length : 0}\nTotal: ${data.paginacion ? data.paginacion.total_items : 0}`);
          } else {
            let errorMsg = `Error ${response.status}: ${response.statusText}`;
            try {
              const errorData = await response.json();
              errorMsg = errorData.detail || errorMsg;
            } catch (e) {
              // Ignorar si no se puede parsear el error
            }
            alert(`‚ùå Error de conexi√≥n:\n${errorMsg}`);
          }
        } catch (error) {
          console.error("üîç Error en prueba:", error);
          alert(`‚ùå Error de red:\n${error.message}`);
        }
      };

      // Escapar HTML para prevenir XSS
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Formatear fecha
      function formatFecha(fechaString) {
        try {
          const fecha = new Date(fechaString);
          return fecha.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        } catch (e) {
          return fechaString;
        }
      }

      /* ---------- Event Listeners ---------- */

      // Buscar clientes
      function buscarClientes() {
        busquedaActual = searchInput.value.trim();
        paginaActual = 1;
        cargarClientes();
      }

      if (btnBuscar) {
        btnBuscar.addEventListener("click", buscarClientes);
      }

      if (searchInput) {
        searchInput.addEventListener("keypress", (e) => {
          if (e.key === 'Enter') {
            buscarClientes();
          }
        });

        // B√∫squeda en tiempo real con debounce
        let timeoutId;
        searchInput.addEventListener("input", (e) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            busquedaActual = e.target.value.trim();
            paginaActual = 1;
            cargarClientes();
          }, 800);
        });
      }

      // Cambio en el filtro de estado
      if (filtroEstado) {
        filtroEstado.addEventListener("change", (e) => {
          filtroActual = e.target.value;
          paginaActual = 1;
          cargarClientes();
        });
      }

      // Inicializar la aplicaci√≥n
      console.log("üöÄ Inicializando aplicaci√≥n de clientes...");
      cargarClientes();
    });
  </script>
</body>

</html>