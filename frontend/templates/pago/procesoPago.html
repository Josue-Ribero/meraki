<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago – Selección de Método</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../static/css/pago/procesoPago.css">
</head>

<body class="bg-[var(--c-off-white)] text-[var(--c-dark-gray)]">
  <div
    class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 items-start min-h-screen px-4 md:px-6 py-8">
    <form class="bg-white p-6 md:p-7 rounded-lg shadow-md w-full space-y-6">
      <h1 class="text-2xl font-bold mb-4">Pago</h1>
      <div>
        <label for="metodo" class="block font-semibold mb-2">Método de Pago</label>
        <select id="metodo" name="metodo" class="w-full border rounded px-3 py-2">
          <option value="NEQUI">Nequi</option>
          <option value="TRANSFERENCIA" disabled>Transferencia (por implementar)</option>
          <option value="DAVIPLATA" disabled>Daviplata (por implementar)</option>
          <option value="EFECTIVO" disabled>Efectivo (por implementar)</option>
          <option value="PUNTOS">Puntos</option>
        </select>
        <div id="transferencia-form" class="mt-6 hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h3 class="font-semibold mb-2 text-yellow-800">Transferencia Bancaria</h3>
          <p class="mb-2 text-sm text-yellow-700">Transfiere a <span class="font-bold">310 1000 100</span></p>
          <label for="referencia" class="block font-semibold mb-1">Referencia de pago</label>
          <input type="text" id="referencia" name="referencia" class="w-full border rounded px-3 py-2 mb-2"
            placeholder="Ingresa referencia o número de comprobante">
        </div>
      </div>
      <div>
        <label class="block font-semibold mb-2">Fecha de Pago</label>
        <input type="text" id="fechaPago" name="fechaPago" class="w-full border rounded px-3 py-2 bg-gray-100"
          value="{{ fecha_pago | default('') }}" readonly placeholder="Cargando fecha...">
      </div>
      <button type="submit" id="confirmar-pago-btn"
        class="w-full bg-[var(--c-gold)] text-white py-3 px-4 rounded-lg font-semibold hover:bg-[var(--c-dark-gold)] transition">
        Confirmar Pago
      </button>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const metodoSelect = document.getElementById('metodo');
          const transferenciaForm = document.getElementById('transferencia-form');
          metodoSelect.addEventListener('change', function () {
            if (this.value === 'TRANSFERENCIA') {
              transferenciaForm.classList.remove('hidden');
            } else {
              transferenciaForm.classList.add('hidden');
            }
          });

          // Manejar el submit del formulario
          const form = document.querySelector('form');
          const confirmarBtn = document.getElementById('confirmar-pago-btn');
          form.addEventListener('submit', function (e) {
            e.preventDefault();
            const metodo = metodoSelect.value;
            const fechaPago = document.getElementById('fechaPago').value;
            // Si es PUNTOS, usar saldo de puntos: enviar a /pagos/crear con usarPuntos=true
            if (metodo === 'PUNTOS') {
              (async () => {
                // Obtener el pedidoID de la URL
                const params = new URLSearchParams(window.location.search);
                const pedidoID = params.get('id') || params.get('pedidoId');
                if (!pedidoID) {
                  alert('No se encontró el pedido.');
                  return;
                }
                try {
                  const fd = new FormData();
                  fd.append('pedidoID', pedidoID);
                  fd.append('metodo', 'PUNTOS');
                  fd.append('usarPuntos', 'true');
                  fd.append('fechaPago', new Date().toISOString());

                  console.debug('procesoPago: enviando pago con puntos', { pedidoID });
                  const resp = await fetch('/pagos/crear', { method: 'POST', body: fd });
                  if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    throw new Error(err.detail || 'Error al procesar el pago con puntos');
                  }
                  // Mostrar mensaje de éxito
                  const exito = document.createElement('div');
                  exito.className = 'mt-4 p-4 bg-green-100 border border-green-300 rounded text-green-800 text-center font-semibold';
                  exito.textContent = '¡Pago con puntos confirmado!';
                  form.appendChild(exito);
                  setTimeout(() => { window.location.href = '/'; }, 1000);
                } catch (err) {
                  const errDiv = document.createElement('div');
                  errDiv.className = 'mt-4 p-3 bg-red-100 border border-red-300 rounded text-red-800 text-center font-semibold';
                  errDiv.textContent = err.message || 'Error al procesar pago con puntos';
                  form.appendChild(errDiv);
                }
              })();
              return;
            }
            // Si es Nequi, mostrar formulario de transferencia y referencia
            if (metodo === 'NEQUI') {
              let nequiForm = document.getElementById('nequi-form');
              if (!nequiForm) {
                nequiForm = document.createElement('div');
                nequiForm.id = 'nequi-form';
                nequiForm.className = 'mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4';
                nequiForm.innerHTML = `
                    <h3 class='font-semibold mb-2 text-blue-800'>Transferencia Nequi</h3>
                    <p class='mb-2 text-sm text-blue-700'>Transfiere a <span class='font-bold'>300 100 1000</span></p>
                    <label for='referencia-nequi' class='block font-semibold mb-1'>Referencia de pago</label>
                    <input type='text' id='referencia-nequi' name='referencia-nequi' class='w-full border rounded px-3 py-2 mb-2' placeholder='Ingresa referencia o número de comprobante'>
                    <button type='button' id='confirmar-nequi-btn' class='w-full bg-[var(--c-gold)] text-white py-2 px-4 rounded-lg font-semibold hover:bg-[var(--c-dark-gold)] transition mt-2'>Confirmar transferencia</button>
                  `;
                form.appendChild(nequiForm);
                document.getElementById('confirmar-nequi-btn').onclick = async function () {
                  const ref = document.getElementById('referencia-nequi').value.trim();
                  if (!ref) {
                    alert('Por favor ingresa la referencia de pago.');
                    return;
                  }
                  // Obtener el pedidoID de la URL
                  const params = new URLSearchParams(window.location.search);
                  const pedidoID = params.get('id') || params.get('pedidoId');
                  if (!pedidoID) {
                    alert('No se encontró el pedido.');
                    return;
                  }
                  // Enviar al backend
                  try {
                    const formData = new FormData();
                    formData.append('pedidoID', pedidoID);
                    formData.append('metodo', 'NEQUI');
                    formData.append('referencia', ref);
                    // Agregar fechaPago en formato ISO
                    formData.append('fechaPago', new Date().toISOString());
                    const response = await fetch('/pagos/crear', {
                      method: 'POST',
                      body: formData
                    });
                    if (!response.ok) {
                      const error = await response.json();
                      throw new Error(error.detail || 'Error al procesar el pago');
                    }
                    nequiForm.innerHTML += `<div class='mt-4 p-3 bg-green-100 border border-green-300 rounded text-green-800 text-center font-semibold'>¡Pago Nequi confirmado!</div>`;
                    console.debug('procesoPago: pago NEQUI confirmado, pedidoID=', pedidoID, 'referencia=', ref);
                    // Reemplazar el botón de confirmar transferencia por un enlace a la tienda (UI)
                    const btn = this;
                    const storeLink = document.createElement('a');
                    storeLink.href = '/';
                    storeLink.className = btn.className;
                    storeLink.textContent = 'Volver a la tienda';
                    btn.replaceWith(storeLink);
                    // Redirigir automáticamente a la tienda tras 1s para confirmar el flujo
                    setTimeout(() => { window.location.href = '/'; }, 1000);
                  } catch (err) {
                    nequiForm.innerHTML += `<div class='mt-4 p-3 bg-red-100 border border-red-300 rounded text-red-800 text-center font-semibold'>${err.message}</div>`;
                  }
                };
              }
              return;
            }
            // Si es transferencia, validar referencia
            let referencia = '';
            if (metodo === 'TRANSFERENCIA') {
              referencia = document.getElementById('referencia').value.trim();
              if (!referencia) {
                alert('Por favor ingresa la referencia de pago.');
                return;
              }
            }
            // Simulación de éxito para otros métodos
            const msg = document.createElement('div');
            msg.className = 'mt-4 p-4 bg-green-100 border border-green-300 rounded text-green-800 text-center font-semibold';
            msg.textContent = '¡Pago confirmado exitosamente!';
            form.appendChild(msg);
            console.debug('procesoPago: pago confirmado (flujo general)');
            // Reemplazar el botón de confirmar por un enlace a la tienda para evitar reenvíos (UI)
            const originalBtn = confirmarBtn;
            const tiendaLink = document.createElement('a');
            tiendaLink.href = '/';
            tiendaLink.className = originalBtn.className;
            tiendaLink.textContent = 'Volver a la tienda';
            originalBtn.replaceWith(tiendaLink);
            // Redirigir automáticamente a la tienda tras 1s para confirmar visualmente
            setTimeout(() => { window.location.href = '/'; }, 1000);
          });
        });
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const metodoSelect = document.getElementById('metodo');
          const transferenciaForm = document.getElementById('transferencia-form');
          metodoSelect.addEventListener('change', function () {
            if (this.value === 'TRANSFERENCIA') {
              transferenciaForm.classList.remove('hidden');
            } else {
              transferenciaForm.classList.add('hidden');
            }
          });
        });
      </script>
    </form>
    <aside class="summary-box bg-white p-6 md:p-7 rounded-lg shadow-md border border-gray-200 w-full">
      <h2 class="section-title mb-6 text-xl font-bold">Resumen del Pago</h2>
      <div class="space-y-4 mb-6">
        <div class="flex justify-between">
          <span class="text-gray-600">Subtotal</span>
          <span id="resumen-subtotal" class="font-semibold">-</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Envío</span>
          <span id="resumen-envio" class="font-semibold">-</span>
        </div>
        <div class="flex justify-between text-lg font-bold border-t border-gray-200 pt-3">
          <span>Total</span>
          <span id="resumen-total" class="text-[var(--c-gold)]">-</span>
        </div>
        <div class="text-sm text-gray-500">* Envío gratis en compras mayores a $30,000</div>
      </div>
      <div class="mt-6">
        <h3 class="font-semibold text-sm text-gray-700 mb-2">Productos</h3>
        <div id="resumen-productos" class="space-y-4">
          <div class="text-center py-6 text-gray-400 animate-pulse" id="resumen-loading">Cargando productos...</div>
        </div>
      </div>
    </aside>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fechaInput = document.getElementById('fechaPago');
      if (fechaInput && !fechaInput.value) {
        const ahora = new Date();
        const opciones = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
        fechaInput.value = ahora.toLocaleDateString('es-CO', opciones).replace(',', '');
      }
    });
  </script>
  <script src="../../static/js/pago/procesoPago.js"></script>
</body>

</html>